<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Roger Beecham and Stephen Clark">
<title>Experiments with MRP for small area estimation in GIScience – MRP-Smart</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-9f30c2c2d2429ed22c1cf9f617479b3b.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-75f438126b92a60c2472acb5310d2e24.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">MRP-Smart</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../proposal/"> 
<span class="menu-text">Proposal</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../demo/"> 
<span class="menu-text">MRP demo</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li>
<a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
<li><a href="#health-survey-for-england-data" id="toc-health-survey-for-england-data" class="nav-link" data-scroll-target="#health-survey-for-england-data">Health Survey for England data</a></li>
  <li><a href="#census-data-and-poststratification-frame" id="toc-census-data-and-poststratification-frame" class="nav-link" data-scroll-target="#census-data-and-poststratification-frame">Census data and poststratification frame</a></li>
  <li><a href="#boundary-data" id="toc-boundary-data" class="nav-link" data-scroll-target="#boundary-data">Boundary data</a></li>
  </ul>
</li>
  <li><a href="#explore-survey-data-look-for-bias" id="toc-explore-survey-data-look-for-bias" class="nav-link" data-scroll-target="#explore-survey-data-look-for-bias">Explore survey data: Look for bias</a></li>
  <li>
<a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a>
  <ul class="collapse">
<li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors">Priors</a></li>
  <li><a href="#example-model-specification" id="toc-example-model-specification" class="nav-link" data-scroll-target="#example-model-specification">Example model specification</a></li>
  <li><a href="#example-analysis-of-model-outputs" id="toc-example-analysis-of-model-outputs" class="nav-link" data-scroll-target="#example-analysis-of-model-outputs">Example analysis of model outputs</a></li>
  </ul>
</li>
  <li><a href="#example-poststratification" id="toc-example-poststratification" class="nav-link" data-scroll-target="#example-poststratification">Example poststratification</a></li>
  <li><a href="#example-sae-evaluation" id="toc-example-sae-evaluation" class="nav-link" data-scroll-target="#example-sae-evaluation">Example SAE evaluation</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Experiments with MRP for small area estimation in GIScience</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Roger Beecham and Stephen Clark </p>
          </div>
  </div>
    
  
    
  </div>
  


</header><section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This document describes a workflow for generating small area outcome estimates using MRP. Originally this work formed a GISRUK abstract (<a href="https://eprints.whiterose.ac.uk/id/eprint/226795/1/mrp_gisruk.pdf">paper</a> | <a href="https://www.roger-beecham.com/slides/mrp/slides.html#/title-slide">talk</a>). Currently, we are turning this into a full paper, but particularly exciting are the wider ambitions to generate a set of place-based indicators as part of Leeds <a href="https://www.sdruk.ukri.org/data/healthy-and-sustainable-places-data-service/">HASP</a> data service.</p>
</section><section id="setup" class="level2"><h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>As well as the usual suspects, listed below are some useful packages for working over (Bayesian) models in a <em>tidy</em> way. <a href="https://paulbuerkner.com/brms/"><code>brms</code></a> is a wrapper to Stan; <a href="https://marginaleffects.com"><code>marginaleffects</code></a> is a very useful package for generating interpretable outputs from model objects (conditional effects in this case); and <a href="https://mjskay.github.io/tidybayes/"><code>tidybayes</code></a> for uncertainty representation extensions to <code>ggplot2</code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Bayesian modelling tools</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstanarm/">rstanarm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/cmdstanr/">cmdstanr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span> <span class="co"># For extracting effect sizes from bayesian objects.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span> <span class="co"># For uncertainty representation.</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/">ggpubr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># library(modelsummary)</span></span>
<span><span class="co"># library(gt)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="st">"theme_clean.R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="st">"plot_helpers.R"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="data" class="level2"><h2 class="anchored" data-anchor-id="data">Data</h2>
<ul>
<li>Survey data (microdata)</li>
<li>Census data: Pop by usual residence in households.</li>
<li>Poststratification frame: Joint counts (and modelled joint counts) by MSOA.</li>
<li>MSOA lookup files, spatial geometry files etc.</li>
</ul>
<section id="health-survey-for-england-data" class="level3"><h3 class="anchored" data-anchor-id="health-survey-for-england-data">Health Survey for England data</h3>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># HEStoFMF.R &gt; Converts to format to be used in FMF</span></span>
<span><span class="co"># HES data (microdata)</span></span>
<span><span class="va">hes_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"Data"</span>, <span class="st">"HES"</span>, <span class="st">"spss"</span>, <span class="st">"spss28"</span>, <span class="st">"HES_for_R.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hes_for_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"FMF"</span>, <span class="st">"HES"</span>, <span class="st">"HESforFMF.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>id<span class="op">=</span><span class="va">Seriala</span>, health<span class="op">=</span><span class="va">genhelf1</span>, <span class="va">SexbyAge</span>, sha<span class="op">=</span><span class="va">SHA2</span>, region<span class="op">=</span><span class="va">GOR2</span>, is_urban<span class="op">=</span><span class="va">urban14b_2</span>, imd<span class="op">=</span><span class="va">qimd19_2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">SexbyAge</span>, names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"age"</span><span class="op">)</span>, delim<span class="op">=</span><span class="st">"."</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Create binary outcome variable.</span></span>
<span>    is_good<span class="op">=</span><span class="va">health</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>,<span class="st">"verygood"</span><span class="op">)</span>,</span>
<span>    <span class="co"># Cast 5-point as factor, for ordinal regression.</span></span>
<span>    health<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">health</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"verybad"</span>, <span class="st">"bad"</span>, <span class="st">"fair"</span>, <span class="st">"good"</span>, <span class="st">"verygood"</span><span class="op">)</span>, ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    is_urban<span class="op">=</span><span class="va">is_urban</span><span class="op">==</span><span class="st">"U"</span>,</span>
<span>    imd<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">imd</span><span class="op">==</span><span class="st">"Least.deprived"</span> <span class="op">~</span> <span class="st">"5"</span>,</span>
<span>      <span class="va">imd</span><span class="op">==</span> <span class="st">"X4"</span> <span class="op">~</span> <span class="st">"2"</span>, </span>
<span>      <span class="va">imd</span><span class="op">==</span> <span class="st">"X3"</span> <span class="op">~</span> <span class="st">"3"</span>,</span>
<span>      <span class="va">imd</span><span class="op">==</span> <span class="st">"X2"</span> <span class="op">~</span> <span class="st">"4"</span>,</span>
<span>      <span class="va">imd</span><span class="op">==</span><span class="st">"Most.deprived"</span> <span class="op">~</span> <span class="st">"1"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">imd</span></span>
<span>      <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sha</span>, <span class="va">region</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"\\."</span>,<span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">hes_raw</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>educ<span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">topqual3</span> <span class="op">==</span> <span class="st">"NVQ4/NVQ5/Degree or equiv"</span> <span class="op">~</span> <span class="st">"level4"</span>,</span>
<span>    <span class="va">topqual3</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Higher ed below degree"</span>,<span class="st">"NVQ3/GCE A Level equiv"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"level3"</span>,</span>
<span>    <span class="va">topqual3</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NVQ1/CSE other grade equiv"</span>,<span class="st">"NVQ2/GCE O Level equiv"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"level1level2"</span>,</span>
<span>    <span class="va">topqual3</span> <span class="op">==</span> <span class="st">"Foreign/other"</span> <span class="op">~</span> <span class="st">"other"</span>,</span>
<span>    <span class="va">topqual3</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"No qualification"</span>,<span class="st">"Refused"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"level0"</span>,</span>
<span>    <span class="va">topqual3</span> <span class="op">==</span> <span class="st">"Not applicable"</span> <span class="op">~</span> <span class="st">"na"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">topqual3</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>id<span class="op">=</span><span class="va">Seriala</span>, <span class="va">educ</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age2<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age0to4"</span>, <span class="st">"age5to15"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"age0to15"</span>,</span>
<span>      <span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age65to74"</span>, <span class="st">"age75p"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"age65p"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">age</span></span>
<span>    <span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="census-data-and-poststratification-frame" class="level3"><h3 class="anchored" data-anchor-id="census-data-and-poststratification-frame">Census data and poststratification frame</h3>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Total households by MSOA</span></span>
<span><span class="va">zone_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"TS001.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>zone_id<span class="op">=</span><span class="va">`Zone ID`</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Groundtruth: Census data</span></span>
<span><span class="va">health</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"GH.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>zone_id<span class="op">=</span><span class="va">`Zone ID`</span><span class="op">)</span></span>
<span><span class="va">geog</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"MSOA21_GOR_SHA_UR_IMD.xlsx"</span><span class="op">)</span>, sheet<span class="op">=</span><span class="st">"MSOA21"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>zone_id<span class="op">=</span><span class="va">MSOA21CD</span>, region<span class="op">=</span><span class="va">GOR2</span>, sha<span class="op">=</span><span class="va">SHA2</span>, is_urban<span class="op">=</span><span class="va">urban14b_2</span>, imd<span class="op">=</span><span class="va">IMD19_1eqMD</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  is_urban<span class="op">=</span><span class="va">is_urban</span><span class="op">==</span><span class="st">"U"</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sha</span>, <span class="va">region</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"\\."</span>,<span class="st">"_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Poststratification frame</span></span>
<span><span class="co"># ps1 : sex by age</span></span>
<span><span class="va">ps1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"SexbyAge.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>zone_id<span class="op">=</span><span class="va">`Zone ID`</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">zone_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">name</span>, names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"age"</span><span class="op">)</span>, delim<span class="op">=</span><span class="st">"."</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>count<span class="op">=</span><span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">zone_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>zone_tot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">sex</span>, <span class="va">age</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>cell_counts<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, prop<span class="op">=</span><span class="va">cell_counts</span><span class="op">/</span><span class="va">zone_tot</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ps2 : sex by age by education level</span></span>
<span><span class="va">ps2</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"SbyAbyQual.xlsx"</span><span class="op">)</span>, sheet<span class="op">=</span><span class="st">"custom-filtered-2024-11-24T15_1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ps2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zone_id"</span>, <span class="st">"zone_name"</span>, <span class="st">"age_code"</span>, <span class="st">"age"</span>, <span class="st">"sex_code"</span>, <span class="st">"sex"</span>, <span class="st">"educ_code"</span>, <span class="st">"educ"</span>, <span class="st">"count"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Checking for different MSOA definitions.</span></span>
<span><span class="va">missing_msoas</span> <span class="op">&lt;-</span> <span class="va">ps2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span><span class="va">educ</span>, delim<span class="op">=</span><span class="st">":"</span>, names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"educ"</span>, <span class="st">"expl"</span><span class="op">)</span>, too_few <span class="op">=</span> <span class="st">"align_start"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">age</span>, <span class="va">sex</span>, <span class="va">educ</span>, <span class="va">count</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span><span class="op">!=</span><span class="st">"Wales"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">zone_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>zone_tot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span><span class="op">!=</span><span class="st">"Wales"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ps1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, r2<span class="op">=</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">zone_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create formatted ps dataset, matching HSE data.</span></span>
<span><span class="va">ps2</span>  <span class="op">&lt;-</span> <span class="va">ps2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span><span class="va">educ</span>, delim<span class="op">=</span><span class="st">":"</span>, names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"educ"</span>, <span class="st">"expl"</span><span class="op">)</span>, too_few <span class="op">=</span> <span class="st">"align_start"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">age</span>, <span class="va">sex</span>, <span class="va">educ</span>, <span class="va">count</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span><span class="op">!=</span><span class="st">"Wales"</span>, <span class="op">!</span><span class="va">zone_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">missing_msoas</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    educ<span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">educ</span> <span class="op">==</span> <span class="st">"Level 4 qualifications or above"</span> <span class="op">~</span> <span class="st">"level4"</span>,</span>
<span>      <span class="va">educ</span> <span class="op">==</span> <span class="st">"Level 3 qualifications"</span> <span class="op">~</span> <span class="st">"level3"</span>,</span>
<span>      <span class="va">educ</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Level 2 qualifications"</span>,<span class="st">"Level 1 and entry level qualifications"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"level1level2"</span>,</span>
<span>      <span class="va">educ</span> <span class="op">==</span> <span class="st">"No qualifications"</span> <span class="op">~</span> <span class="st">"level0"</span>,</span>
<span>      <span class="va">educ</span> <span class="op">==</span> <span class="st">"Does not apply"</span> <span class="op">~</span> <span class="st">"na"</span>,</span>
<span>      <span class="va">educ</span> <span class="op">==</span> <span class="st">"Other"</span> <span class="op">~</span> <span class="st">"other"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">educ</span><span class="op">)</span> <span class="op">)</span>,</span>
<span>    sex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"Aged 15 years and under"</span> <span class="op">~</span> <span class="st">"age0to15"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"Aged 16 to 24 years"</span> <span class="op">~</span> <span class="st">"age16to24"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"Aged 25 to 34 years"</span> <span class="op">~</span> <span class="st">"age25to34"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"Aged 35 to 49 years"</span> <span class="op">~</span> <span class="st">"age35to49"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"Aged 50 to 64 years"</span> <span class="op">~</span> <span class="st">"age50to64"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"Aged 65 years and over"</span> <span class="op">~</span> <span class="st">"age65p"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">age</span> <span class="op">)</span>,</span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">zone_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>zone_tot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">sex</span>, <span class="va">age</span>, <span class="va">educ</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>cell_counts<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, prop<span class="op">=</span><span class="va">cell_counts</span><span class="op">/</span><span class="va">zone_tot</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify differences in MSOA codes between the HSE and MSOA lookup datasets.</span></span>
<span><span class="co"># missing_msoas &lt;- t |&gt; left_join(geog) |&gt; filter(region!="Wales") |&gt; select(zone_id, region) |&gt; unique() |&gt; left_join(ps1|&gt; select(zone_id, r2=region) |&gt; unique() ) |&gt; filter(is.na(r2)) |&gt; pull(zone_id)</span></span>
<span><span class="co"># LIST of MSOAs not in ps1but present in ps2</span></span>
<span><span class="co"># Joining with `by = join_by(zone_id)`</span></span>
<span><span class="co"># Joining with `by = join_by(zone_id)`</span></span>
<span><span class="co"># # A tibble: 14 × 3</span></span>
<span><span class="co">#    zone_id   region                   r2   </span></span>
<span><span class="co">#    &lt;chr&gt;     &lt;chr&gt;                    &lt;chr&gt;</span></span>
<span><span class="co">#  1 E02002524 North_East               NA   </span></span>
<span><span class="co">#  2 E02002526 North_East               NA   </span></span>
<span><span class="co">#  3 E02002693 Yorkshire_and_the_Humber NA   </span></span>
<span><span class="co">#  4 E02003897 South_West               NA   </span></span>
<span><span class="co">#  5 E02003972 North_West               NA   </span></span>
<span><span class="co">#  6 E02003974 North_West               NA   </span></span>
<span><span class="co">#  7 E02004243 South_West               NA   </span></span>
<span><span class="co">#  8 E02004631 South_West               NA   </span></span>
<span><span class="co">#  9 E02005184 North_West               NA   </span></span>
<span><span class="co"># 10 E02005327 North_West               NA   </span></span>
<span><span class="co"># 11 E02005713 North_East               NA   </span></span>
<span><span class="co"># 12 E02005721 North_East               NA   </span></span>
<span><span class="co"># 13 E02005727 North_East               NA   </span></span>
<span><span class="co"># 14 E02005915 East_Midlands            NA   </span></span>
<span></span>
<span><span class="co"># Population size of those missing MSOAs : 88536</span></span>
<span><span class="va">ps2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span><span class="op">!=</span><span class="st">"Wales"</span>, <span class="op">!</span><span class="va">zone_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">missing_msoas</span> <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>tot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cell_counts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># 55415266</span></span>
<span><span class="va">ps1</span><span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>tot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cell_counts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># 55415499</span></span>
<span><span class="co"># Overall difference in zone totals, with hhd also of 233.</span></span>
<span></span>
<span><span class="co"># Check levels exactly match between the survey and postratification frame.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span></span>
<span>  <span class="va">ps2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">hes_for_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="boundary-data" class="level3"><h3 class="anchored" data-anchor-id="boundary-data">Boundary data</h3>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># MSOAs : Bring down from ONS Open Geography Portal and simplify. </span></span>
<span><span class="co"># msoa_boundaries &lt;- st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Middle_layer_Super_Output_Areas_December_2021_Boundaries_EW_BSC_V3/FeatureServer/0/query?outFields=*&amp;where=1%3D1&amp;f=geojson") |&gt; </span></span>
<span><span class="co"># rmapshaper::ms_simplify(keep_shapes = TRUE)</span></span>
<span><span class="co"># st_write(msoa_boundaries, here("data", "msoa_boundaries.geojson"))</span></span>
<span><span class="va">msoa_boundaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"msoa_boundaries.geojson"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="explore-survey-data-look-for-bias" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="explore-survey-data-look-for-bias">Explore survey data: Look for bias</h2>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Binary outcome.</span></span>
<span><span class="va">temp_freqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span> <span class="op">(</span></span>
<span>  <span class="va">ps2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sex</span><span class="op">:</span><span class="va">cell_counts</span>, <span class="va">region</span>, <span class="va">is_urban</span>, <span class="va">imd</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>is_urban<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">is_urban</span><span class="op">)</span>, imd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">imd</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cell_counts</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"var_name"</span>, values_to <span class="op">=</span> <span class="st">"val"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">var_name</span>, <span class="va">val</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cell_counts</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"Census"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">hes_for_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">is_good</span>,<span class="va">sha</span>, <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>age<span class="op">=</span><span class="va">age2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>is_urban<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">is_urban</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">health</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"var_name"</span>, values_to <span class="op">=</span> <span class="st">"val"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">var_name</span>, <span class="va">val</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"HSE"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">bias_hse</span> <span class="op">&lt;-</span> <span class="va">temp_freqs</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from<span class="op">=</span><span class="va">var_name</span>, values_from<span class="op">=</span><span class="va">val</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    imd<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">imd</span><span class="op">==</span><span class="st">"1"</span> <span class="op">~</span> <span class="st">"1 most"</span>,</span>
<span>      <span class="va">imd</span><span class="op">==</span> <span class="st">"5"</span> <span class="op">~</span> <span class="st">"5 least"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">imd</span></span>
<span>      <span class="op">)</span>,</span>
<span>    region<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"East_Midlands"</span> <span class="op">~</span> <span class="st">"EM"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"East_of_England"</span> <span class="op">~</span> <span class="st">"E"</span>, </span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"North_East"</span> <span class="op">~</span> <span class="st">"NE"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"North_West"</span> <span class="op">~</span> <span class="st">"NW"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"South_East"</span> <span class="op">~</span> <span class="st">"SE"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"South_West"</span> <span class="op">~</span> <span class="st">"SW"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"West_Midlands"</span> <span class="op">~</span> <span class="st">"WM"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"Yorkshire_and_the_Humber"</span> <span class="op">~</span> <span class="st">"Y&amp;H"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">region</span><span class="op">)</span>,</span>
<span>    educ<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level0"</span> <span class="op">~</span> <span class="st">"0. none"</span>,</span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level1level2"</span> <span class="op">~</span> <span class="st">"1. 2+ GCSEs"</span>, </span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level3"</span> <span class="op">~</span> <span class="st">"3. A-levels"</span>, </span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level4"</span> <span class="op">~</span> <span class="st">"4. degree +"</span>,</span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"na"</span> <span class="op">~</span> <span class="st">"na/other"</span>,</span>
<span>       <span class="va">educ</span><span class="op">==</span><span class="st">"other"</span> <span class="op">~</span> <span class="st">"na/other"</span>,</span>
<span>      <span class="op">)</span>,</span>
<span>    age<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"age0to15"</span> <span class="op">~</span> <span class="st">"0-15"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"age16to24"</span> <span class="op">~</span> <span class="st">"16-24"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"age25to34"</span> <span class="op">~</span> <span class="st">"25-34"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"age35to49"</span> <span class="op">~</span> <span class="st">"35-49"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"age50to64"</span> <span class="op">~</span> <span class="st">"50-64"</span>,</span>
<span>      <span class="va">age</span> <span class="op">==</span> <span class="st">"age65p"</span> <span class="op">~</span> <span class="st">"65+"</span><span class="op">)</span>,</span>
<span>    is_urban<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">is_urban</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">~</span> <span class="st">"rural"</span>,</span>
<span>      <span class="va">is_urban</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"urban"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">count</span>, <span class="va">type</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"var_name"</span>, values_to <span class="op">=</span> <span class="st">"val"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>var_name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">var_name</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"educ"</span>, <span class="st">"imd"</span>, <span class="st">"is_urban"</span>, <span class="st">"region"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">var_name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">val</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop<span class="op">=</span><span class="va">count</span><span class="op">/</span><span class="va">tot</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">val</span>, y<span class="op">=</span><span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"HSE"</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"#636363"</span>, alpha<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_spoke.html">geom_spoke</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"Census"</span><span class="op">)</span>, angle<span class="op">=</span><span class="fl">0</span>, radius<span class="op">=</span><span class="fl">.5</span>, position<span class="op">=</span><span class="st">"center_spoke"</span>,alpha<span class="op">=</span><span class="fl">1</span>, linewidth<span class="op">=</span><span class="fl">.8</span>, colour<span class="op">=</span><span class="st">"#08519c"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">.</span><span class="op">~</span><span class="va">var_name</span>, scales<span class="op">=</span><span class="st">"free_x"</span>, space<span class="op">=</span><span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    y<span class="op">=</span><span class="st">"% in &lt;span style='color: #08519c;'&gt;**Census**&lt;/span&gt; vs &lt;span style='color: #636363;'&gt;**HSE**&lt;/span&gt;"</span>, </span>
<span>    x<span class="op">=</span><span class="st">""</span>, </span>
<span>    title<span class="op">=</span><span class="st">"Difference between 2021 &lt;span style='color: #636363;'&gt;**HSE**&lt;/span&gt; sample and &lt;span style='color: #08519c;'&gt;**Census**&lt;/span&gt; population"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">35</span><span class="op">)</span>,</span>
<span>    axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>    axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle<span class="op">=</span><span class="fl">270</span>, hjust <span class="op">=</span> <span class="fl">0</span>, size<span class="op">=</span><span class="fl">35</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">40</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">60</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">".."</span>, <span class="st">"figs"</span>, <span class="st">"bias_hse2.png"</span><span class="op">)</span>, <span class="va">bias_hse</span>, width<span class="op">=</span><span class="fl">8</span>, height<span class="op">=</span><span class="fl">4.5</span>, dpi<span class="op">=</span><span class="fl">300</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="fig-bias-hse" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" width="100%">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-bias-hse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../figs/bias_hse2.png" id="fig-bias-hse" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig quarto-uncaptioned margin-caption" id="fig-bias-hse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1
</figcaption></figure>
</div>
</div>
</div>
</section><section id="model" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="model">Model</h2>
<p>I am following primers on MRP:</p>
<ul>
<li>
<a href="https://statmodeling.stat.columbia.edu/2022/05/31/multilevel-regression-and-poststratification-case-studies/">Juan Lopez-Martin + others</a>, via <code>brms</code> and <code>stanarm</code>
</li>
<li>
<a href="https://bookdown.org/content/4857/models-with-memory.html">Solomon Kurz</a>, via <code>brms</code>
</li>
<li>
<a href="https://rohanalexander.github.io/telling_stories-published/15-mrp.html">Nathan Alexander</a>, via <code>stanarm</code>
</li>
</ul>
<p>Also, I have been consulting Andrew Heiss’s detailed posts on working with logistic regression multilevel model outputs: <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/#posterior-predictions">here</a> and <a href="https://www.andrewheiss.com/blog/2023/08/12/conjoint-multilevel-multinomial-guide/#bayesian-comparisonscontrasts">here</a>.</p>
<p>General practice in MRP is to include every variable as a random intercept / level and so fully-pool estimates of the outcome. That makes sense, but it means that it’s hard to interpret and justify model-based decisions on variables included in the model. While general practice is to include as many demographics and geography variables as possible, as long as they can still compute, if we are interested in ultimately building some SPM, then it is useful to require parsimony in the variables used. But interpreting these hierarchical Bayesian model outputs is hard. What I do here is:</p>
<ol type="1">
<li><p>Generate posterior predictions for each level in the model and look at how narrow the CIs are for those values. This is using <a href="https://marginaleffects.com/bonus/brms.html">marginal effects</a>.</p></li>
<li><p>Generate posterior conditional effects for each level in them, again using <a href="https://marginaleffects.com/bonus/brms.html">marginal effects</a>.</p></li>
<li><p>Extract the “condition_mean”, as per <a href="https://rohanalexander.github.io/telling_stories-published/15-mrp.html">Alexander 2023</a> – but I need to check what this means.</p></li>
</ol>
<section id="priors" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="priors">Priors</h3>
<p>We parameterise our models using:</p>
<ol type="1">
<li><p>An informed prior on the intercept. We have some experience with stated response surveys and health outcomes. Our expectation is that most will identify as in good health – c.&nbsp;75%. So for the multilevel logistic regression, our intercept is a Gaussian set on log-odds scale, we use <span class="math inline">\(Normal(mean=0.5, sd=1)\)</span>.</p></li>
<li><p>The multilevel priors are set to <span class="math inline">\(exponential(1)\)</span> as a default.</p></li>
<li><p>The <code>adept_delta</code> setting is to .95 – common when a hierarchical grouping variable has few levels.</p></li>
</ol>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span>, mean <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"#636363"</span>, binwidth <span class="op">=</span> <span class="fl">.02</span>, boundary <span class="op">=</span> <span class="fl">0</span>, alpha<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title<span class="op">=</span><span class="st">"&lt;span&gt;theoretical **prior** on intercept&lt;/span&gt;"</span>, </span>
<span>    x<span class="op">=</span><span class="st">"baseline % **good** health"</span>, y<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.title<span class="op">=</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">35</span><span class="op">)</span>, </span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">60</span><span class="op">)</span>,</span>
<span>    axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">".."</span>, <span class="st">"figs"</span>, <span class="st">"prior.png"</span><span class="op">)</span>, <span class="va">p</span>, width<span class="op">=</span><span class="fl">4.5</span>, height<span class="op">=</span><span class="fl">3</span>, dpi<span class="op">=</span><span class="fl">300</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="fig-prior" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" width="70%">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../figs/prior.png" id="fig-prior" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig quarto-uncaptioned margin-caption" id="fig-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2
</figcaption></figure>
</div>
</div>
</div>
</section><section id="example-model-specification" class="level3"><h3 class="anchored" data-anchor-id="example-model-specification">Example model specification</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 5.53914 mins</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>model7 <span class="ot">&lt;-</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> hes_for_model,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">bernoulli</span>(),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      is_good <span class="sc">~</span> sex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> age2) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> educ) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> imd) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> region) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> is_urban), <span class="co">#+ (1 | educ:age2),</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">#is_good ~ sex + (1 | age),</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">set_prior</span>(<span class="st">"normal(0.5, 1)"</span>, <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"normal(0, 1)"</span>, <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"exponential(1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group=</span><span class="st">"age2"</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"exponential(1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group=</span><span class="st">"educ"</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"exponential(1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group=</span><span class="st">"imd"</span>),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"exponential(1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group=</span><span class="st">"region"</span>),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"exponential(1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group=</span><span class="st">"is_urban"</span>)<span class="co">#,</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># set_prior("exponential(1)", class = "sd", group="educ:age2")</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains=</span><span class="dv">4</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">"cmdstanr"</span>, </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>))</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">Sys.time</span>()<span class="sc">-</span>start)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(model, file = here("MRP", "fit_hse_7.rds"))</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(model, file = here("MRP", "fit_hse_7_nointeract.rds"))</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co"># model &lt;- readRDS(here("..", "models", "fit_hse_7.rds"))</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>model7 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">here</span>(<span class="st">".."</span>, <span class="st">"models"</span> <span class="st">"fit_hse_7_nointeract.rds"</span>))</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> hes_for_model,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">bernoulli</span>(),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>      is_good <span class="sc">~</span> sex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> age2),</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">set_prior</span>(<span class="st">"normal(0.5, 1)"</span>, <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"normal(0, 1)"</span>, <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_prior</span>(<span class="st">"exponential(1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group=</span><span class="st">"age2"</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">chains=</span><span class="dv">4</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">"cmdstanr"</span>, </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>))</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(model1, file = here("..", "models", "fit_hse_1.rds"))</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">here</span>(<span class="st">".."</span>, <span class="st">"models"</span>, <span class="st">"fit_hse_1.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="example-analysis-of-model-outputs" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="example-analysis-of-model-outputs">Example analysis of model outputs</h3>
<p>The benefit of modern packages for computational model-building (and Bayesian approach) is that we can take advantage of resampling procedures to derive more interpretable quantities for the variables included in our model. For example, we can ask about the predicted probability of a particular characteristic individual, or an individual living in a particular place, reporting a <code>good</code> health outcome. Or what the average difference in likelihood of reporting a good health outcome is for a hypothetical individual of a particular age versus a hypothetical individual of another age group (conditional on other characteristics being consistent with the sample average).</p>
<p>The <code>marginaleffects</code> package provides a set of functions to do this – to look at posterior predicted values and comparisons (contrasts) for different, user specified, individuals. There are a few key functions:</p>
<ul>
<li>
<p><code><a href="https://marginaleffects.com/man/r/predictions.html">marginaleffects::predictions()</a></code> extracts from a model the predicted probability in this case of a survey respondent reporting a <code>good</code> health outcome. To this function we supply a <code>newdata</code> argument with a grid of person characteristics that we want to predict over/for, and a <code>type</code> argument setting the scale with which to return predictions. By default <code><a href="https://marginaleffects.com/man/r/predictions.html">marginaleffects::predictions()</a></code> returns for each row (respondent) in the dataset, but we might want to return predicted values for:</p>
<ul>
<li>A specific demographic combination (as in postratification frame)</li>
<li>A hypothetical individual with each predictor held at the sample average (mean / mode).</li>
</ul>
</li>
<li><p><code><a href="https://marginaleffects.com/man/r/predictions.html">marginaleffects::avg_predictions()</a></code> takes the average of all predicted values of the dataset – so imagine predicting out for each observation (respondent) and averaging out their predicted probabilities. But this becomes more useful when we pass a <code>by</code> argument to predict for actually observed values of our dataset – e.g.&nbsp;for particular ages or other characteristics, what is the average probability of the outcome, given our model?</p></li>
<li><p><code><a href="https://marginaleffects.com/man/r/comparisons.html">marginaleffects::comparisons()</a></code> compares two sets of predictions made with different predictor values. The quantity of interest is the difference in predictions when, say, <code>age</code> takes on different values. This is done via parameterising the <code>variables</code> argument. Risk differences are <em>conditional</em> quantities, which vary with the values of all predictors in the model. By default we obtain the comparison (risk difference) for each unit of observation.</p></li>
</ul>
<p>So below, I inspect the predicted probability of good health by key demographics and comparing <code>model1</code> (using only sex and age) with <code>model7</code>, which uses many more covariates.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">var_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age2"</span>, <span class="st">"educ"</span>, <span class="st">"region"</span>, <span class="st">"imd"</span>, <span class="st">"is_urban"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">variable</span>, <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">hes_for_model</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">""</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html">is.logical</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">levels</span><span class="op">)</span>  </span>
<span></span>
<span><span class="va">model_var_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">var_levels</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"age2"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"model1"</span><span class="op">)</span>, </span>
<span>  <span class="va">var_levels</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"model7"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map2_df</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">model1</span>, <span class="va">model7</span><span class="op">)</span>, </span>
<span>  .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"model1"</span>, <span class="st">"model7"</span><span class="op">)</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_df</a></span><span class="op">(</span><span class="va">model_var_levels</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="va">.y</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>           <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>             <span class="fu"><a href="https://marginaleffects.com/man/r/predictions.html">avg_predictions</a></span><span class="op">(</span><span class="va">.x</span>, by <span class="op">=</span> <span class="va">var</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>               <span class="fu"><a href="https://marginaleffects.com/man/r/posterior_draws.html">posterior_draws</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>               <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>condition <span class="op">=</span> <span class="va">var</span>, model <span class="op">=</span> <span class="va">.y</span><span class="op">)</span> </span>
<span>           <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">model_preds</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">age2</span>, <span class="st">"age\\d+p$"</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">age2</span>, <span class="st">"age(\\d+)p"</span>, <span class="st">"\\1+"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">age2</span>, <span class="st">"age\\d+to\\d+"</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">age2</span>, <span class="st">"age(\\d+)to(\\d+)"</span>, <span class="st">"\\1 - \\2"</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">age2</span><span class="op">)</span>,</span>
<span>    imd<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">imd</span><span class="op">==</span><span class="st">"1"</span> <span class="op">~</span> <span class="st">"1 most"</span>,</span>
<span>      <span class="va">imd</span><span class="op">==</span> <span class="st">"5"</span> <span class="op">~</span> <span class="st">"5 least"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">imd</span></span>
<span>      <span class="op">)</span>,</span>
<span>    region<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"East_Midlands"</span> <span class="op">~</span> <span class="st">"EM"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"East_of_England"</span> <span class="op">~</span> <span class="st">"E"</span>, </span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"North_East"</span> <span class="op">~</span> <span class="st">"NE"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"North_West"</span> <span class="op">~</span> <span class="st">"NW"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"South_East"</span> <span class="op">~</span> <span class="st">"SE"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"South_West"</span> <span class="op">~</span> <span class="st">"SW"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"West_Midlands"</span> <span class="op">~</span> <span class="st">"WM"</span>,</span>
<span>      <span class="va">region</span><span class="op">==</span><span class="st">"Yorkshire_and_the_Humber"</span> <span class="op">~</span> <span class="st">"Y&amp;H"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">region</span><span class="op">)</span>,</span>
<span>    educ<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level0"</span> <span class="op">~</span> <span class="st">"0. none"</span>,</span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level1level2"</span> <span class="op">~</span> <span class="st">"1. 2+ GCSEs"</span>, </span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level3"</span> <span class="op">~</span> <span class="st">"3. A-levels"</span>, </span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"level4"</span> <span class="op">~</span> <span class="st">"4. degree +"</span>,</span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"na"</span> <span class="op">~</span> <span class="st">"na/other"</span>,</span>
<span>      <span class="va">educ</span><span class="op">==</span><span class="st">"other"</span> <span class="op">~</span> <span class="st">"na/other"</span>,</span>
<span>      <span class="op">)</span>,</span>
<span>    is_urban<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">is_urban</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">~</span> <span class="st">"rural"</span>,</span>
<span>      <span class="va">is_urban</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"urban"</span><span class="op">)</span>,</span>
<span>    cat_val <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">condition</span> <span class="op">==</span> <span class="st">"age2"</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="va">age2</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="va">condition</span> <span class="op">==</span> <span class="st">"educ"</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="va">educ</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="va">condition</span> <span class="op">==</span> <span class="st">"region"</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="va">condition</span> <span class="op">==</span> <span class="st">"imd"</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="va">imd</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="va">condition</span> <span class="op">==</span> <span class="st">"is_urban"</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="va">is_urban</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">plot_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">educ</span> <span class="op">==</span> <span class="st">"na/other"</span> <span class="op">&amp;</span> <span class="va">condition</span> <span class="op">==</span> <span class="st">"educ"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">cat_val</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/stat_gradientinterval.html">stat_gradientinterval</a></span><span class="op">(</span></span>
<span>    slab_size <span class="op">=</span> <span class="fl">3</span>,  </span>
<span>    <span class="co">#normalize = "xy", </span></span>
<span>    show_interval <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    show_point <span class="op">=</span> <span class="cn">FALSE</span>,   </span>
<span>    colour<span class="op">=</span><span class="st">"#525252"</span>,</span>
<span>   fill<span class="op">=</span><span class="st">"#525252"</span></span>
<span>  <span class="op">)</span>  <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_spoke.html">geom_spoke</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">condition</span>, <span class="va">cat_val</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>draw<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">draw</span><span class="op">)</span><span class="op">)</span>, angle<span class="op">=</span><span class="fu">get_radians</span><span class="op">(</span><span class="fl">90</span><span class="op">)</span>, radius<span class="op">=</span><span class="fl">.5</span>, position<span class="op">=</span><span class="st">"center_spoke"</span>,alpha<span class="op">=</span><span class="fl">1</span>, linewidth<span class="op">=</span><span class="fl">.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="op">)</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>,<span class="fl">.7</span>,<span class="fl">.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Predicted probability of **good** health"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Predicting over demographics by **model**"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.major.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fl">.777</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, linewidth<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.45</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">condition</span><span class="op">~</span><span class="va">model</span>, scales<span class="op">=</span><span class="st">"free_y"</span>, space<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">35</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">60</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">".."</span>, <span class="st">"figs"</span>, <span class="st">"predictions.png"</span><span class="op">)</span>, <span class="va">p</span>, width<span class="op">=</span><span class="fl">6.5</span>, height<span class="op">=</span><span class="fl">5</span>, dpi<span class="op">=</span><span class="fl">300</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="fig-predictions" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" width="100%">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-predictions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../figs/predictions.png" id="fig-predictions" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig quarto-uncaptioned margin-caption" id="fig-predictions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3
</figcaption></figure>
</div>
</div>
</div>
<p>Here I use <code><a href="https://marginaleffects.com/man/r/comparisons.html">avg_comparisons()</a></code> to analyse the average marginal component effect of moving between age ranges, education levels etc. holding other features constant. So with marginal effects, we ask what happens to an outcome when the explanatory variable moves, in this case, between levels. This corresponds with how one would normally interpret coefficients from a regression model.</p>
<p>This function works as follows, as per <a href="https://marginaleffects.com/chapters/comparisons.html"><code>marginaleffects</code> documentation</a>:</p>
<blockquote class="blockquote">
<ol type="1">
<li>Compute predictions for every row of the dataset in the counterfactual world where all observations belong to the treatment condition.</li>
<li>Compute predictions for every row of the dataset in the counterfactual world where all observations belong to the control condition.</li>
<li>Take the differences between the two vectors of predictions.</li>
<li>Average the unit-level estimates across the whole dataset, or within subgroups.</li>
</ol>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 2.9 mins</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>model_effects <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="fu">list</span>(model1, model7), </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">.y =</span> <span class="fu">c</span>(<span class="st">"model1"</span>, <span class="st">"model7"</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">map_df</span>(model_var_levels <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span> .y) <span class="sc">|&gt;</span> <span class="fu">pull</span>(variable) <span class="sc">|&gt;</span> <span class="fu">unique</span>(),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>           <span class="cf">function</span>(var) {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">avg_comparisons</span>(.x, <span class="at">variable =</span> var, <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>               <span class="fu">posterior_draws</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>               <span class="fu">add_column</span>(<span class="at">condition=</span> var, <span class="at">model =</span> .y)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>           })</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">Sys.time</span>()<span class="sc">-</span>start)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>effects_nested <span class="ot">&lt;-</span> model_effects <span class="sc">%&gt;%</span> </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_wider_delim</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    contrast,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">delim =</span> <span class="st">" - "</span>, </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">names =</span> <span class="fu">c</span>(<span class="st">"variable_level"</span>, <span class="st">"reference_level"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(variable_level, reference_level, model) <span class="sc">%&gt;%</span> </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="fu">map2_df</span>(</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="fu">list</span>(model1, model7), </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">.y =</span> <span class="fu">c</span>(<span class="st">"model1"</span>, <span class="st">"model7"</span>),</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">map_df</span>(model_var_levels <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span> .y) <span class="sc">|&gt;</span> <span class="fu">pull</span>(variable) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> model_var_levels <span class="sc">|&gt;</span> </span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    effects_nested,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(levels <span class="sc">==</span> variable_level, model <span class="sc">==</span> model)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map_if</span>(data, is.null, <span class="sc">~</span> <span class="fu">tibble</span>(<span class="at">draw =</span> <span class="dv">0</span>, <span class="at">estimate =</span> <span class="dv">0</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>plot_data_m1 <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span><span class="st">"model1"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from=</span>condition, <span class="at">values_from=</span>levels) <span class="sc">|&gt;</span> </span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age2 =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(age2, <span class="st">"age</span><span class="sc">\\</span><span class="st">d+p$"</span>) <span class="sc">~</span> <span class="fu">str_replace</span>(age2, <span class="st">"age(</span><span class="sc">\\</span><span class="st">d+)p"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1+"</span>),</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(age2, <span class="st">"age</span><span class="sc">\\</span><span class="st">d+to</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">~</span> <span class="fu">str_replace</span>(age2, <span class="st">"age(</span><span class="sc">\\</span><span class="st">d+)to(</span><span class="sc">\\</span><span class="st">d+)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1 - </span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(age2) <span class="sc">~</span> <span class="st">"0 - 15"</span>,</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> age2),</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">cat_val =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"age2"</span> <span class="sc">~</span> <span class="fu">pick</span>(age2) <span class="sc">|&gt;</span>  <span class="fu">pull</span>(),</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, variable, draw, cat_val)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>plot_data_m7 <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span><span class="st">"model7"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from=</span>condition, <span class="at">values_from=</span>levels) <span class="sc">|&gt;</span> </span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age2 =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(age2, <span class="st">"age</span><span class="sc">\\</span><span class="st">d+p$"</span>) <span class="sc">~</span> <span class="fu">str_replace</span>(age2, <span class="st">"age(</span><span class="sc">\\</span><span class="st">d+)p"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1+"</span>),</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(age2, <span class="st">"age</span><span class="sc">\\</span><span class="st">d+to</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">~</span> <span class="fu">str_replace</span>(age2, <span class="st">"age(</span><span class="sc">\\</span><span class="st">d+)to(</span><span class="sc">\\</span><span class="st">d+)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1 - </span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(age2) <span class="sc">~</span> <span class="st">"0 - 15"</span>,</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> age2),</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">imd=</span><span class="fu">case_when</span>(</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      imd<span class="sc">==</span><span class="st">"1"</span> <span class="sc">~</span> <span class="st">"1 most"</span>,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      imd<span class="sc">==</span> <span class="st">"5"</span> <span class="sc">~</span> <span class="st">"5 least"</span>,</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(imd) <span class="sc">~</span> <span class="st">"1 most"</span>,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> imd</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">region=</span><span class="fu">case_when</span>(</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"East_Midlands"</span> <span class="sc">~</span> <span class="st">"EM"</span>,</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"East_of_England"</span> <span class="sc">~</span> <span class="st">"E"</span>, </span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"North_East"</span> <span class="sc">~</span> <span class="st">"NE"</span>,</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"North_West"</span> <span class="sc">~</span> <span class="st">"NW"</span>,</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"South_East"</span> <span class="sc">~</span> <span class="st">"SE"</span>,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"South_West"</span> <span class="sc">~</span> <span class="st">"SW"</span>,</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"West_Midlands"</span> <span class="sc">~</span> <span class="st">"WM"</span>,</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>      region<span class="sc">==</span><span class="st">"Yorkshire_and_the_Humber"</span> <span class="sc">~</span> <span class="st">"Y&amp;H"</span>,</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(region) <span class="sc">~</span> <span class="st">"EM"</span>,</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> region),</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">educ=</span><span class="fu">case_when</span>(</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>      educ<span class="sc">==</span><span class="st">"level0"</span> <span class="sc">~</span> <span class="st">"0. none"</span>,</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>      educ<span class="sc">==</span><span class="st">"level1level2"</span> <span class="sc">~</span> <span class="st">"1. 2+ GCSEs"</span>, </span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>      educ<span class="sc">==</span><span class="st">"level3"</span> <span class="sc">~</span> <span class="st">"3. A-levels"</span>, </span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>      educ<span class="sc">==</span><span class="st">"level4"</span> <span class="sc">~</span> <span class="st">"4. degree +"</span>,</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>      educ<span class="sc">==</span><span class="st">"na"</span> <span class="sc">~</span> <span class="st">"na/other"</span>,</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>      educ<span class="sc">==</span><span class="st">"other"</span> <span class="sc">~</span> <span class="st">"na/other"</span>,</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(educ) <span class="sc">~</span> <span class="st">"0. none"</span>,</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> educ</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_urban=</span><span class="fu">case_when</span>(</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>      is_urban <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">~</span> <span class="st">"rural"</span>,</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>      is_urban <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"urban"</span>,</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(is_urban) <span class="sc">~</span> <span class="st">"rural"</span>,</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> is_urban</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">cat_val =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"age2"</span> <span class="sc">~</span> <span class="fu">pick</span>(age2) <span class="sc">|&gt;</span>  <span class="fu">pull</span>(),</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"educ"</span> <span class="sc">~</span> <span class="fu">pick</span>(educ) <span class="sc">|&gt;</span>  <span class="fu">pull</span>(),</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"region"</span> <span class="sc">~</span> <span class="fu">pick</span>(region) <span class="sc">|&gt;</span>  <span class="fu">pull</span>(),</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"imd"</span> <span class="sc">~</span> <span class="fu">pick</span>(imd) <span class="sc">|&gt;</span>  <span class="fu">pull</span>(),</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"is_urban"</span> <span class="sc">~</span> <span class="fu">pick</span>(is_urban) <span class="sc">|&gt;</span>  <span class="fu">pull</span>(),</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, variable, draw, cat_val)</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(plot_data_m1, plot_data_m7)  </span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span> </span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> draw, <span class="at">y =</span> cat_val)) <span class="sc">+</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_gradientinterval</span>(</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">slab_size =</span> <span class="dv">3</span>,  </span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">#normalize = "xy", </span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_interval =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_point =</span> <span class="cn">FALSE</span>,   </span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour=</span><span class="st">"#525252"</span>,</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>   <span class="at">fill=</span><span class="st">"#525252"</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spoke</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(model, variable, cat_val) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">draw=</span><span class="fu">mean</span>(draw)), <span class="at">angle=</span><span class="fu">get_radians</span>(<span class="dv">90</span>), <span class="at">radius=</span>.<span class="dv">5</span>, <span class="at">position=</span><span class="st">"center_spoke"</span>,<span class="at">alpha=</span><span class="dv">1</span>, <span class="at">linewidth=</span>.<span class="dv">5</span>, <span class="at">colour=</span><span class="st">"#525252"</span>) <span class="sc">+</span> </span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">0</span>, <span class="at">colour=</span><span class="st">"#525252"</span>, <span class="at">linewidth=</span>.<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(variable<span class="sc">~</span>model, <span class="at">scales=</span><span class="st">"free_y"</span>, <span class="at">space=</span><span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">#facet_grid(variable~., scales="free_y", space="free_y") +</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Posterior 'marginal effects'"</span>,</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    <span class="co">#subtitle = "-- moving between levels of explanatory variables",</span></span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="st">"% change in **good** health from control level"</span>, <span class="at">y=</span><span class="st">""</span></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_markdown</span>(<span class="at">size=</span><span class="dv">35</span>),</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">size=</span><span class="dv">60</span>),</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_markdown</span>(<span class="at">size=</span><span class="dv">35</span>),</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>),</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">30</span>)</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">here</span>(<span class="st">".."</span>, <span class="st">"figs"</span>,<span class="st">"comparisons.png"</span>), p, <span class="at">width=</span><span class="fl">6.5</span>, <span class="at">height=</span><span class="dv">5</span>, <span class="at">dpi=</span><span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="fig-comparisons" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" width="100%">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-comparisons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../figs/comparisons.png" id="fig-comparisons" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig quarto-uncaptioned margin-caption" id="fig-comparisons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="example-poststratification" class="level2"><h2 class="anchored" data-anchor-id="example-poststratification">Example poststratification</h2>
<p>At poststratification, we predict over the outcome for each of the ‘strata’ defined by the poststratification frame (<code>ps</code>). I’ve wrapped this into a function so that we poststratify per model. Here I also calculate absolute errors for each postratification model prediction.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Predict over binary outcome mode</span></span>
<span><span class="va">ps_health</span> <span class="op">&lt;-</span>  <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">model_spec</span>, <span class="va">ps</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">ps</span>, ndraws<span class="op">=</span><span class="fl">500</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>pred_good_health <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pred_good_health_prop <span class="op">=</span> <span class="va">pred_good_health</span> <span class="op">*</span> <span class="va">prop</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>pred_good_health <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_good_health_prop</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">.draw</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pred_good_health</span><span class="op">)</span>,</span>
<span>    lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">pred_good_health</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>    upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">pred_good_health</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">zone_id</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">health</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>obs_good <span class="op">=</span> <span class="va">good</span><span class="op">+</span><span class="va">verygood</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">obs_good</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">zone_totals</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    exp_good<span class="op">=</span><span class="va">mean</span><span class="op">*</span><span class="va">hhd</span>, </span>
<span>    exp_notgood<span class="op">=</span><span class="va">hhd</span><span class="op">-</span><span class="va">exp_good</span>,</span>
<span>    obs_notgood<span class="op">=</span><span class="va">hhd</span><span class="op">-</span><span class="va">obs_good</span>,</span>
<span>    sum_tae<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">exp_good</span><span class="op">-</span><span class="va">obs_good</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">exp_notgood</span><span class="op">-</span><span class="va">obs_notgood</span><span class="op">)</span>,</span>
<span>    prop_tae<span class="op">=</span><span class="va">sum_tae</span><span class="op">/</span><span class="va">hhd</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">exp_good</span>, <span class="va">exp_notgood</span>, <span class="va">obs_good</span>, <span class="va">obs_notgood</span><span class="op">)</span>, values_to<span class="op">=</span><span class="st">"count"</span>, names_to<span class="op">=</span><span class="st">"type"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">type</span>, names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">"health"</span><span class="op">)</span>, delim<span class="op">=</span><span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">type</span>, values_from <span class="op">=</span> <span class="va">count</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>mrp<span class="op">=</span><span class="va">model_spec</span><span class="op">)</span></span>
<span> </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I then post-stratify over each model, within a <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mrp_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map2_df</a></span><span class="op">(</span></span>
<span>  .x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">model1</span>, <span class="va">model</span><span class="op">)</span>, </span>
<span>  .y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"model1"</span>, <span class="st">"model7"</span><span class="op">)</span>,</span>
<span>  <span class="op">~</span><span class="fu">ps_health</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span>, <span class="va">ps2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age2<span class="op">=</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results from the <code>FMF</code> (spatial microsimulation model) are stored in a separate <code>.csv</code> file. After loading into the session, I refactor this data frame so that it can be joined, with <code>bind_rows</code>, on the MRP results.</p>
<p>So <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows()</a></code> on MRP and FMF results.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">fmf_results</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">spec</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sex_age"</span>, <span class="st">"educ_imd_region"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>spec<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">spec</span><span class="op">==</span><span class="st">"sex_age"</span>, <span class="st">"model1"</span>, <span class="st">"model7"</span><span class="op">)</span>, mean<span class="op">=</span><span class="fl">0</span>, lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">0</span><span class="op">)</span> , </span>
<span>  <span class="va">mrp_results</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hhd</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>spec<span class="op">=</span><span class="va">mrp</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"mrp"</span><span class="op">)</span>  <span class="co">#|&gt; select(-c(mean, lower, upper))</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">spec</span><span class="op">!=</span><span class="st">"Census"</span>, <span class="va">spec</span><span class="op">!=</span><span class="st">"RM42_46_120_SxA_qimd19"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hhd</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    perc_obs<span class="op">=</span><span class="va">obs</span><span class="op">/</span><span class="va">hhd</span>, perc_exp<span class="op">=</span><span class="va">exp</span><span class="op">/</span><span class="va">hhd</span>, perc_tae<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">perc_obs</span><span class="op">-</span><span class="va">perc_exp</span><span class="op">)</span>,</span>
<span>    resid<span class="op">=</span><span class="op">(</span><span class="va">obs</span><span class="op">-</span><span class="va">exp</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another external table is that describing Information Entropy scores, per area, on the outcome estimates derived from the spatial microsimulation. This describes how much our models need to draw from a diminishing set of survey respondents, as we constrain on more variables.</p>
</section><section id="example-sae-evaluation" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="example-sae-evaluation">Example SAE evaluation</h2>
<p>Staging data for plots.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">health</span><span class="op">==</span><span class="st">"good"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid<span class="op">=</span><span class="op">(</span><span class="va">obs</span><span class="op">-</span><span class="va">exp</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span>, perc_obs<span class="op">=</span><span class="va">obs</span><span class="op">/</span><span class="va">hhd</span>, perc_exp<span class="op">=</span><span class="va">exp</span><span class="op">/</span><span class="va">hhd</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">spec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    resid_est<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">resid</span><span class="op">)</span>, resid_var<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">resid</span><span class="op">)</span>,</span>
<span>    obs_est<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, obs_var<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>,</span>
<span>    exp_est<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span>, exp_var<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">type</span>, <span class="va">spec</span>, resid_val<span class="op">=</span><span class="va">resid</span>, <span class="va">resid_est</span>, <span class="va">resid_var</span>, </span>
<span>         obs_val<span class="op">=</span><span class="va">obs</span>, exp_val<span class="op">=</span><span class="va">exp</span>, <span class="va">obs_est</span>, <span class="va">obs_var</span>, <span class="va">exp_est</span>, <span class="va">exp_var</span>, <span class="va">perc_obs</span>, <span class="va">perc_exp</span>, <span class="va">sum_tae</span>, <span class="va">prop_tae</span>, <span class="va">perc_tae</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">type</span>, <span class="va">spec</span>, <span class="va">sum_tae</span>, <span class="va">prop_tae</span>, <span class="va">perc_tae</span><span class="op">)</span>, names_to<span class="op">=</span><span class="st">"stat"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span><span class="va">stat</span>, delim<span class="op">=</span><span class="st">"_"</span>, names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"stat"</span>, <span class="st">"stat_type"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from<span class="op">=</span><span class="va">stat_type</span>, values_from<span class="op">=</span><span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lower<span class="op">=</span><span class="va">est</span><span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">var</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">6842</span><span class="op">)</span><span class="op">)</span>, upper<span class="op">=</span><span class="va">est</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">var</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">6842</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    spec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">spec</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"model1"</span>, <span class="st">"model7"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For plots evaluating model performance, I generate several helper functions. These are quite specialised to the HSE case, so I need to return to these to generalise when doing comparisons on other model case studies.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Map residuals</span></span>
<span><span class="va">map_resids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">censor</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Spatial extent of geog.</span></span>
<span>  <span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">map_width</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span></span>
<span>  <span class="va">map_height</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymin</span></span>
<span>  </span>
<span>  <span class="co"># Draw map</span></span>
<span>  <span class="va">map</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="va">resid</span>,<span class="va">censor</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">.45</span>, colour<span class="op">=</span><span class="st">"#525252"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">resid</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">.25</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span><span class="op">)</span><span class="op">+</span><span class="fl">.2</span><span class="op">*</span><span class="va">map_width</span>, <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">)</span><span class="op">+</span><span class="fl">.5</span><span class="op">*</span><span class="va">map_width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"RdBu"</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">censor</span>,<span class="va">censor</span><span class="op">)</span>, direction<span class="op">=</span><span class="fl">1</span><span class="op">)</span>   <span class="op">+</span></span>
<span>  <span class="co"># Annotate model performance.</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">+</span><span class="fl">.2</span><span class="op">*</span><span class="va">map_width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="fl">.2</span><span class="op">*</span><span class="va">map_height</span>, label<span class="op">=</span><span class="st">"MAE"</span><span class="op">)</span>, hjust<span class="op">=</span><span class="st">"right"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">sum_tae</span><span class="op">)</span>,perc_mae<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">perc_tae</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">+</span><span class="fl">.2</span><span class="op">*</span><span class="va">map_width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="fl">.28</span><span class="op">*</span><span class="va">map_height</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"# "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mae</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, hjust<span class="op">=</span><span class="st">"right"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">sum_tae</span><span class="op">)</span>,perc_mae<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">perc_tae</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">+</span><span class="fl">.2</span><span class="op">*</span><span class="va">map_width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="fl">.36</span><span class="op">*</span><span class="va">map_height</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"% "</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">perc_mae</span><span class="op">*</span><span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, hjust<span class="op">=</span><span class="st">"right"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Strip out chart assembly.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, </span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">bars</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="va">resid</span>,<span class="va">censor</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html">after_stat</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"bin"</span>, colour <span class="op">=</span> <span class="st">"#525252"</span>, linewidth <span class="op">=</span> <span class="fl">.15</span>, </span>
<span>           position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_nudge.html">position_nudge</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">-</span><span class="fl">.55</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># Fill with the same palette as the map</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"RdBu"</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">censor</span>,<span class="va">censor</span><span class="op">)</span>, direction<span class="op">=</span><span class="fl">1</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span>   <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">censor</span>, <span class="va">censor</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span>,</span>
<span>    axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">map</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html">inset_element</a></span><span class="op">(</span><span class="va">bars</span>,<span class="fl">.65</span>,<span class="op">-</span><span class="fl">.1</span>,<span class="fl">1</span>,<span class="fl">.55</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Map Entropy / Prediction intervals</span></span>
<span><span class="va">map_intervals</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">max_scaled</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Spatial extent of geog.</span></span>
<span>  <span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">map_width</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span></span>
<span>  <span class="va">map_height</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymin</span></span>
<span>  </span>
<span>  <span class="va">map</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>interval <span class="op">=</span> <span class="va">interval</span><span class="op">/</span><span class="va">max_scaled</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">.4</span>, colour<span class="op">=</span><span class="st">"#525252"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">interval</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">.25</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span><span class="op">)</span><span class="op">+</span><span class="fl">.1</span><span class="op">*</span><span class="va">map_width</span>, <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">)</span><span class="op">+</span><span class="fl">.5</span><span class="op">*</span><span class="va">map_width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Blues"</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, direction<span class="op">=</span><span class="fl">1</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, </span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">bars</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>interval <span class="op">=</span> <span class="va">interval</span><span class="op">/</span><span class="va">max_scaled</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">interval</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html">after_stat</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"bin"</span>, colour <span class="op">=</span> <span class="st">"#525252"</span>, linewidth <span class="op">=</span> <span class="fl">.1</span>, </span>
<span>           position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_nudge.html">position_nudge</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">-</span><span class="fl">.015</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># Fill with the same palette as the map</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Blues"</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, direction<span class="op">=</span><span class="fl">1</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">.9</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span>,</span>
<span>    axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">map</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html">inset_element</a></span><span class="op">(</span><span class="va">bars</span>,<span class="fl">.65</span>,<span class="op">-</span><span class="fl">.1</span>,<span class="fl">1</span>,<span class="fl">.55</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co"># Map shannon</span></span>
<span><span class="va">map_shannon</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">max_scaled</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Spatial extent of geog.</span></span>
<span>  <span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">map_width</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span></span>
<span>  <span class="va">map_height</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymin</span></span>
<span>  </span>
<span>  <span class="va">map</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>entropy <span class="op">=</span> <span class="va">shannon</span><span class="op">/</span><span class="va">max_scaled</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">.4</span>, colour<span class="op">=</span><span class="st">"#525252"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">entropy</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">.25</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span><span class="op">)</span><span class="op">+</span><span class="fl">.1</span><span class="op">*</span><span class="va">map_width</span>, <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">)</span><span class="op">+</span><span class="fl">.5</span><span class="op">*</span><span class="va">map_width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Blues"</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, direction<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, </span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">bars</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>entropy <span class="op">=</span> <span class="va">shannon</span><span class="op">/</span><span class="va">max_scaled</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">entropy</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html">after_stat</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"bin"</span>, colour <span class="op">=</span> <span class="st">"#525252"</span>, linewidth <span class="op">=</span> <span class="fl">.1</span>, </span>
<span>           position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_nudge.html">position_nudge</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">-</span><span class="fl">.015</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># Fill with the same palette as the map</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Blues"</span>, limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, direction<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">.9</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span>,</span>
<span>    axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">map</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html">inset_element</a></span><span class="op">(</span><span class="va">bars</span>,<span class="fl">.65</span>,<span class="op">-</span><span class="fl">.1</span>,<span class="fl">1</span>,<span class="fl">.55</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co"># Model labs</span></span>
<span><span class="va">model_labs</span><span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spec</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="va">p</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">0</span>,y<span class="op">=</span><span class="fl">.5</span>, label<span class="op">=</span><span class="va">spec</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"middle"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">9</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span>,        </span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>   </span>
<span>  <span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I then iterate over each model and generate plot summaries: maps of residuals, of prediction intervals (MRP) and Information Emntropy (SPM).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">subsets_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"model1"</span>, <span class="st">"model7"</span><span class="op">)</span></span>
<span><span class="va">subsets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"mrp"</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"fmf"</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>, spec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">subsets_order</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span><span class="va">subsets</span>,  </span>
<span>                 <span class="op">~</span><span class="fu">map_resids</span><span class="op">(</span></span>
<span>                   dat<span class="op">=</span><span class="va">results</span> <span class="op">|&gt;</span></span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">health</span><span class="op">==</span><span class="st">"good"</span>, <span class="va">type</span><span class="op">==</span><span class="va">..1</span>, <span class="va">spec</span><span class="op">==</span><span class="va">..2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">msoa_boundaries</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zone_id"</span><span class="op">=</span><span class="st">"MSOA21CD"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   censor<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">max_scaled</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"mrp"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>interval<span class="op">=</span><span class="va">upper</span><span class="op">-</span><span class="va">lower</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>max<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">interval</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_intervals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span><span class="va">subsets</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"mrp"</span><span class="op">)</span>, </span>
<span>                 <span class="op">~</span><span class="fu">map_intervals</span><span class="op">(</span></span>
<span>                   dat<span class="op">=</span><span class="va">results</span> <span class="op">|&gt;</span></span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="va">..1</span>, <span class="va">spec</span><span class="op">==</span><span class="va">..2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">msoa_boundaries</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zone_id"</span><span class="op">=</span><span class="st">"MSOA21CD"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>interval<span class="op">=</span><span class="va">upper</span><span class="op">-</span><span class="va">lower</span><span class="op">)</span>,</span>
<span>                   <span class="va">max_scaled</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">spec</span><span class="op">==</span><span class="va">..2</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">max</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span>                 <span class="op">)</span></span>
<span></span>
<span><span class="va">max_scaled</span> <span class="op">&lt;-</span> <span class="va">shannon</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>max<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">shannon</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">p_shannon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span><span class="va">subsets</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"fmf"</span><span class="op">)</span>, </span>
<span>                 <span class="op">~</span><span class="fu">map_shannon</span><span class="op">(</span></span>
<span>                   dat<span class="op">=</span><span class="va">shannon</span> <span class="op">|&gt;</span></span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="va">..1</span>, <span class="va">spec</span><span class="op">==</span><span class="va">..2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">msoa_boundaries</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zone_id"</span><span class="op">=</span><span class="st">"MSOA21CD"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">geog</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">zone_id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="va">max_scaled</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">spec</span><span class="op">==</span><span class="va">..2</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">max</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span>                 <span class="op">)</span></span>
<span><span class="va">p_model_labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">subsets</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"mrp"</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">~</span><span class="fu">model_labs</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate patchwork plots for each model summary type</span></span>
<span><span class="va">composite_labs</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p_model_labs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_model_labs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">composite_resids_mrp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p_resids</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_resids</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">composite_resids_spm</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p_resids</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_resids</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">composite_shannon</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p_shannon</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_shannon</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">composite_intervals</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p_intervals</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_intervals</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View composition of each of these summaries.</span></span>
<span><span class="va">comp_plot</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">composite_labs</span> <span class="op">|</span> <span class="va">composite_resids_mrp</span> <span class="op">|</span> <span class="va">composite_intervals</span> <span class="op">|</span>  <span class="va">composite_resids_spm</span> <span class="op">|</span> <span class="va">composite_shannon</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.25</span>,<span class="fl">1</span>,<span class="fl">.9</span>, <span class="fl">1</span>,<span class="fl">.9</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">comp_plot_gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/patchworkGrob.html">patchworkGrob</a></span><span class="op">(</span><span class="va">comp_plot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Annotate composed plots.</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.1</span>,<span class="fl">1.05</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1.05</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_custom.html">annotation_custom</a></span><span class="op">(</span><span class="va">comp_plot_gg</span>, xmin <span class="op">=</span> <span class="fl">0</span>, ymin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">1</span>, ymax <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span>,       </span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#ffffff"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,  </span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#ffffff"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>    </span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Model titles</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.25</span>,y<span class="op">=</span><span class="fl">1.05</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">12</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"MRP"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.73</span>,y<span class="op">=</span><span class="fl">1.05</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">12</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"SPM"</span> <span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  </span>
<span>  <span class="co"># Legends: fiddly use of annotate, as &lt;br&gt; unexpected in ggtext.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"segment"</span>, x<span class="op">=</span><span class="fl">0</span>,y<span class="op">=</span><span class="fl">0</span>, xend<span class="op">=</span><span class="fl">1.05</span>, yend<span class="op">=</span><span class="fl">0</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, linewidth<span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.08</span>,y<span class="op">=</span><span class="fl">0</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>  size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"Residuals: obs-model / sqrt(model)"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.1</span>,y<span class="op">=</span><span class="op">-</span><span class="fl">.03</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"&lt;span style='color: #b2182b'&gt;**underestimate**&lt;/span&gt; |</span></span>
<span><span class="st">           &lt;span style='color: #2166ac;'&gt;**overestimate**&lt;/span&gt;"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.31</span>,y<span class="op">=</span><span class="fl">.0</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"Prediction intervals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.31</span>,y<span class="op">=</span><span class="op">-</span><span class="fl">.03</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"&lt;span style='color: #9ecae1;'&gt;**narrower**&lt;/span&gt; | &lt;span style='color: #084594;'&gt;**wider**&lt;/span&gt;"</span><span class="op">)</span> <span class="op">+</span></span>
<span>           </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.8</span>,y<span class="op">=</span><span class="fl">.0</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"Entropy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.8</span>, y<span class="op">=</span><span class="op">-</span><span class="fl">.03</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>, </span>
<span>             label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, </span>
<span>             fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>             label <span class="op">=</span> <span class="st">"&lt;span style='color: #9ecae1;'&gt;**high diversity**&lt;/span&gt; | &lt;span style='color: #084594;'&gt;**low diversity**&lt;/span&gt;&lt;br&gt;~ more respondents"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.55</span>,y<span class="op">=</span><span class="fl">0</span>, hjust<span class="op">=</span><span class="st">"left"</span>, vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"Mean abs error:"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"richtext"</span>, x<span class="op">=</span><span class="fl">.55</span>,y<span class="op">=</span><span class="op">-</span><span class="fl">.03</span>, hjust<span class="op">=</span><span class="st">"left"</span>, vjust<span class="op">=</span><span class="st">"top"</span>, label.colour <span class="op">=</span> <span class="cn">NA</span>, size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>,</span>
<span>           label<span class="op">=</span><span class="st">"&lt;span&gt;# good &amp; bad | % good&lt;/span&gt;"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">.67</span>,y<span class="op">=</span><span class="fl">.065</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>,  size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, </span>
<span>           label<span class="op">=</span><span class="st">"Extreme estimates"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">.67</span>,y<span class="op">=</span><span class="fl">.035</span>, hjust<span class="op">=</span><span class="st">"left"</span>,vjust<span class="op">=</span><span class="st">"top"</span>,  size<span class="op">=</span><span class="fl">6.5</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, </span>
<span>           label<span class="op">=</span><span class="st">"are censored"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"curve"</span>, x<span class="op">=</span><span class="fl">.72</span>, xend<span class="op">=</span><span class="fl">.76</span>, y<span class="op">=</span><span class="fl">.075</span>, yend<span class="op">=</span><span class="fl">.12</span>, linewidth<span class="op">=</span><span class="fl">.2</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.006</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>, curvature <span class="op">=</span> <span class="op">-</span><span class="fl">0.4</span><span class="op">)</span>  </span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">".."</span>, <span class="st">"figs"</span>, <span class="st">"model_summary.png"</span><span class="op">)</span>, <span class="va">p</span>, width<span class="op">=</span><span class="fl">8</span>, height<span class="op">=</span><span class="fl">4</span>, dpi<span class="op">=</span><span class="fl">300</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="fig-models" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" width="100%">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../figs/model_summary.png" id="fig-models" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig quarto-uncaptioned margin-caption" id="fig-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5
</figcaption></figure>
</div>
</div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->



</body></html>